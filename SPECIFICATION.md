# 家計簿アプリケーション 仕様書

## 1. アプリケーション概要

家計簿アプリケーションは、二人のユーザー間で月次の家計簿を管理し、支出項目を共有・分割するWebアプリケーションです。一人が請求者として支出項目を入力し、もう一人の支払者が支払いを確定するワークフローを提供します。

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS + Vite + nginx (セキュリティ強化済み)
- **バックエンド**: Go 1.23 + Gin Framework + GORM + JWT認証 (セキュリティ強化済み)
- **データベース**: MySQL 8.0 (Docker Secrets対応)
- **コンテナ**: Docker + Docker Compose (セキュリティ強化済み)
- **ルーティング**: React Router v6
- **セキュリティ**: CSRF保護・レート制限・SSL/HTTPS・セキュリティヘッダー

## 2. 機能一覧（Must）

### 2.1 認証・ユーザー管理機能
- **ユーザー登録**: 新規ユーザーアカウントの作成
- **ログイン**: 既存ユーザーの認証
- **JWT認証**: トークンベースのセッション管理
- **ユーザー情報取得**: 現在ログインしているユーザー情報の取得
- **ユーザー一覧取得**: 家計簿共有のためのユーザー選択

### 2.2 月次家計簿管理機能
- **家計簿作成**: 指定年月の新規家計簿作成（請求者・支払者指定）
- **家計簿一覧表示**: ユーザーに関連する全家計簿の一覧表示
- **家計簿詳細取得**: 特定年月の家計簿詳細情報取得
- **家計簿削除**: 不要な家計簿の削除機能

### 2.3 支出項目管理機能
- **項目追加**: 支出項目の新規追加
- **項目編集**: 既存項目の名前・金額修正
- **項目削除**: 不要項目の削除
- **項目一括更新**: 複数項目の同時更新
- **金額計算**: 総額の自動計算

### 2.4 ワークフロー管理機能
- **ステータス管理**: 作成中(pending) → 請求済み(requested) → 支払済み(paid)
- **請求確定**: 請求者による項目確定・請求送信
- **支払確定**: 支払者による支払い完了確認
- **権限制御**: 請求者・支払者別のアクション制限

### 2.5 データ整合性機能
- **重複防止**: 同一年月・同一請求者の家計簿重複作成防止
- **同一ユーザー制限**: 請求者と支払者の同一ユーザー設定防止
- **削除制限**: 請求者のみ・pending状態のみ削除可能

### 2.6 支払者向け機能
- **支払者家計簿表示**: 自身が支払者指定された家計簿の参照機能
- **ステータス別カード表示**: requested(黄色背景)・paid(緑色背景)の視覚的区分
- **支払権限**: 支払確定ボタンによる家計簿完了処理

### 2.7 UI/UX機能
- **レスポンシブデザイン**: PC・タブレット・スマホ対応
- **ナビゲーション**: ヘッダーメニュー・適切なページ遷移
- **エラーハンドリング**: APIエラー・バリデーションエラー表示
- **ローディング状態**: 非同期処理の視覚的フィードバック
- **ビジュアルフィードバック**: 操作結果の明確な表示

## 3. ユースケース（Must）

### 3.1 新規家計簿作成のユースケース

**アクター**: 請求者（ユーザー）

**前提条件**:
- ユーザーがログイン済み
- 支払者となるユーザーがシステムに登録済み

**メインフロー**:
1. ユーザーが家計簿一覧ページにアクセスする
2. 「新規作成」ボタンをクリックする
3. 作成フォームで年・月・支払者を入力する
4. 「作成」ボタンをクリックする
5. システムが家計簿を作成し、詳細ページにリダイレクトする

**成功後条件**:
- 新しい家計簿が作成される（状態: pending）
- 請求者が自分、支払者が指定ユーザーに設定される
- 家計簿一覧に新しい家計簿が表示される

### 3.2 支出項目入力・編集のユースケース

**アクター**: 請求者

**前提条件**:
- 家計簿が作成済み（状態: pending）
- ユーザーが請求者として家計簿にアクセス権限を持つ

**メインフロー**:
1. 請求者が家計簿詳細ページにアクセスする
2. 項目入力フォームに項目名と金額を入力する
3. 「項目追加」ボタンをクリックする
4. システムが項目を保存し、総額を自動計算する
5. 既存項目の編集も同様に行う

**成功後条件**:
- 支出項目が家計簿に追加/更新される
- 総額がリアルタイムで更新される
- 項目一覧に反映される

### 3.3 家計簿請求・確定のユースケース

**アクター**: 請求者

**前提条件**:
- 家計簿に1つ以上の支出項目が登録済み
- 家計簿の状態がpending

**メインフロー**:
1. 請求者が家計簿詳細ページで「請求を確定」ボタンをクリックする
2. システムが家計簿の状態をrequestedに変更する
3. 請求日時が記録される
4. 支払者に家計簿請求が通知される（UI上で状態変更が確認可能）

**成功後条件**:
- 家計簿の状態がrequestedに変更される
- 項目の編集が不可能になる
- 支払者が支払い処理を実行可能になる

### 3.4 支払い確定のユースケース

**アクター**: 支払者

**前提条件**:
- 家計簿の状態がrequested
- ユーザーが支払者として設定されている

**メインフロー**:
1. 支払者が家計簿詳細ページにアクセスする
2. 請求内容を確認する
3. 「支払いを確定」ボタンをクリックする
4. システムが家計簿の状態をpaidに変更する
5. 支払日時が記録される

**成功後条件**:
- 家計簿の状態がpaidに変更される
- 家計簿のワークフローが完了する
- 両ユーザーから完了状態が確認可能になる

### 3.5 家計簿一覧表示のユースケース

**アクター**: 全ユーザー

**前提条件**:
- ユーザーがログイン済み

**メインフロー**:
1. ユーザーが家計簿一覧ページにアクセスする
2. システムがユーザーに関連する家計簿を取得する（請求者・支払者どちらの立場でも）
3. 家計簿をカード形式で一覧表示する
4. 各家計簿に総額・状態・役割を表示する
5. ユーザーが詳細ページへのリンクをクリックする

**成功後条件**:
- 関連する全家計簿が表示される
- 各家計簿の基本情報・金額・状態が確認できる
- 詳細ページへの遷移が可能になる

### 3.6 権限制御のユースケース

**アクター**: 請求者・支払者

**前提条件**:
- ユーザーが特定の家計簿にアクセス

**メインフロー**:
1. システムがユーザーの役割（請求者/支払者）を判定する
2. 請求者の場合: 項目編集・請求確定ボタンを表示する
3. 支払者の場合: 閲覧・支払確定ボタンのみ表示する
4. 状態に応じて操作可能なアクションを制限する

**成功後条件**:
- 適切な権限でのみ操作が実行可能になる
- 誤操作・不正操作が防止される

## 4. データモデル

### 4.1 User（ユーザー）
```typescript
{
  id: number;              // ユーザーID
  name: string;            // ユーザー名
  account_id: string;      // アカウントID（ログイン用）
  password_hash: string;   // パスワードハッシュ
  created_at: string;      // 作成日時
  updated_at: string;      // 更新日時
}
```

### 4.2 MonthlyBill（月次家計簿）
```typescript
{
  id: number;              // 家計簿ID
  year: number;            // 対象年
  month: number;           // 対象月
  requester_id: number;    // 請求者ID
  payer_id: number;        // 支払者ID
  status: 'pending' | 'requested' | 'paid';  // 状態
  request_date?: string;   // 請求日時
  payment_date?: string;   // 支払日時
  requester: User;         // 請求者情報
  payer: User;             // 支払者情報
  items: BillItem[];       // 支出項目一覧
  created_at: string;      // 作成日時
  updated_at: string;      // 更新日時
}
```

### 4.3 BillItem（支出項目）
```typescript
{
  id: number;              // 項目ID
  bill_id: number;         // 所属家計簿ID
  item_name: string;       // 項目名
  amount: number;          // 金額
  created_at: string;      // 作成日時
  updated_at: string;      // 更新日時
}
```

## 5. API仕様

### 5.1 認証API
- `POST /api/auth/register` - ユーザー登録
- `POST /api/auth/login` - ログイン
- `GET /api/auth/me` - 現在ユーザー情報取得

### 5.2 ユーザー管理API
- `GET /api/users` - ユーザー一覧取得

### 5.3 家計簿管理API
- `GET /api/bills` - 家計簿一覧取得（請求者・支払者両方の家計簿）
- `GET /api/bills/:year/:month` - 特定家計簿取得
- `GET /api/bills/:id` - 家計簿詳細取得（ID指定）
- `POST /api/bills` - 家計簿作成（重複チェック付き）
- `DELETE /api/bills/:id` - 家計簿削除（請求者・pending状態限定）
- `PUT /api/bills/:id/items` - 支出項目更新
- `PUT /api/bills/:id/request` - 請求確定
- `PUT /api/bills/:id/payment` - 支払確定

### 5.4 セキュリティ・監視API
- `GET /health` - ヘルスチェック
- `GET /api/csrf-token` - CSRFトークン取得
- `GET /api/security-status` - セキュリティ監視情報
- `POST /api/auth/logout` - ログアウト（JWTトークン無効化）
- `POST /api/auth/logout-all` - 全デバイスログアウト
- `GET /api/auth/token-status` - トークンステータス確認

## 6. セキュリティ要件（Phase 3 実装完了）

### 6.1 認証・認可（✅ 実装済み）
- JWT トークンベース認証（環境変数・Docker Secrets対応）
- パスワードのbcryptハッシュ化
- API エンドポイントの認証必須化
- ユーザー別アクセス制御
- セッション無効化機能（ログアウト・全デバイスログアウト）
- JWTトークンブラックリスト機能

### 6.2 データ保護（✅ 実装済み）
- CORS設定による外部アクセス制限
- SQLインジェクション対策（ORM + 入力値検証）
- XSS防止（入力値サニタイゼーション）
- 機密情報のログ出力防止
- Docker Secrets によるパスワード保護

### 6.3 通信セキュリティ（✅ 実装済み）
- SSL/HTTPS対応（OpenSSL証明書）
- CSRF保護（utrack/gin-csrf）
- セキュリティヘッダー実装
  - Content-Security-Policy
  - X-Frame-Options
  - X-Content-Type-Options
  - X-XSS-Protection
  - Referrer-Policy
  - Permissions-Policy

### 6.4 アプリケーションセキュリティ（✅ 実装済み）
- 3段階APIレート制限
  - 一般API: 100req/min (burst: 20)
  - 認証API: 10req/min (burst: 3)
  - 作成系API: 30req/min (burst: 10)
- 入力値検証・サニタイゼーション
- セキュアエラーハンドリング（情報漏洩防止）

### 6.5 インフラセキュリティ（✅ 実装済み）
- 非rootユーザーでのコンテナ実行
- 最小限イメージの使用（scratch base）
- コンテナセキュリティ強化

### 6.6 監視・管理（✅ 実装済み）
- セキュリティ監視エンドポイント
- レート制限状況の可視化
- トークンブラックリスト監視

**総合リスク評価: LOW** - Phase 3 完了により本番環境対応済み

## 7. 非機能要件

### 7.1 性能要件
- ページ読み込み時間: 3秒以内
- API レスポンス時間: 1秒以内
- 同時接続ユーザー数: 100名程度

### 7.2 可用性要件
- システム稼働率: 99%以上
- データベースバックアップ: 日次
- エラー処理とユーザーフレンドリーなメッセージ表示

### 7.3 拡張性要件
- Docker化による環境構築の簡素化
- マイクロサービス アーキテクチャへの移行可能性
- ユーザー数・データ量増加への対応

## 8. 運用要件

### 8.1 開発環境
- Docker Compose による簡単環境構築
- ホットリロード対応
- 開発・本番環境の分離

### 8.2 デプロイメント
- コンテナベースデプロイメント
- 環境変数による設定管理
- ログ出力とモニタリング

## 9. 品質保証・テスト

### 9.1 テスト体系
**Backend テスト** (カバレッジ 87.3%):
- ユニットテスト: 15テストケース（モック使用）
- 統合テスト: 41テストケース（実DB使用）
- 契約テスト: 17テストケース（API仕様検証）
- パフォーマンステスト: 67.3倍高速化実現（SQLite InMemory）

**Frontend テスト** (E2E 268テストケース):
- 基本UI動作: 12テスト（4ブラウザ対応）
- 機能テスト: 重複チェック・ユーザーフロー・権限制御
- ビジュアルリグレッション: 32テスト（UI変更自動検出）
- パフォーマンス監視: Core Web Vitals測定
- クロスプラットフォーム: Desktop/Mobile Chrome・Safari対応

### 9.2 継続的品質保証
- 自動テスト実行: Backend 0.02s・Frontend 5-20分
- CI/CD統合: Make/npmコマンドによる自動化
- API仕様書自動生成: 契約テストによる実装同期保証

## 10. 制限事項

### 10.1 現在の制限
- 2ユーザー間の家計簿のみサポート（3人以上未対応）
- 画像添付機能なし
- 通知機能なし（メール・プッシュ通知）
- レポート・分析機能なし
- ダッシュボード機能廃止（仕様変更により削除）

### 10.2 セキュリティ制限（Phase 3 完了により解決済み）
- ✅ 本番環境対応済み（セキュリティレベル大幅向上）
- ✅ クリティカル脆弱性 全て解決済み
- ✅ HTTPS通信対応済み

**残り対応項目（Phase 4: 低リスク）:**
- 監査ログ機能の強化
- 脆弱性スキャンの自動化
- バックアップ戦略の策定

### 10.3 今後の拡張可能性
- 画像レシート添付
- 自動分類・タグ機能
- 月次・年次レポート生成
- モバイルアプリ化
- ✅ セキュリティ強化完了（HTTPS・CSRF・認証改善・レート制限・セキュリティヘッダー）
